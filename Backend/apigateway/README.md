# API Gateway Service

This is the API Gateway for the Food Delivery System Cloud Application. It serves as the central entry point for all client requests and routes them to appropriate backend services based on authentication and authorization.

## 🚀 Features

- **Centralized Authentication**: JWT token generation and validation
- **Role-based Routing**: Routes requests based on user roles (CUSTOMER/RESTAURANT)
- **Service Proxy**: Forwards requests to auth, order, and inventory services
- **CORS Support**: Configured for frontend integration
- **Security**: JWT-based authentication with role-based access control
- **Health Monitoring**: Built-in health check endpoints
- **Error Handling**: Comprehensive error handling and meaningful responses

## 🏗️ Architecture

The API Gateway acts as a reverse proxy and authentication layer:

```
Frontend Applications
        ↓
API Gateway (Port 8080)
        ↓
┌─────────────────────────────────┐
│ Backend Services                │
│ • Auth Service (8081)           │
│ • Order Service (9094)          │  
│ • Inventory Service (9093)      │
└─────────────────────────────────┘
```

## 📋 API Endpoints

### Public Endpoints (No Authentication Required)

#### Health & Info
```bash
GET /api/health          # Service health check
GET /api/info           # Service information
```

#### Authentication
```bash
POST /api/auth/register  # User registration
POST /api/auth/login     # User login
GET /api/auth/validate   # Token validation
```

### Protected Endpoints (JWT Token Required)

#### Orders (CUSTOMER role only)
```bash
GET /api/orders/my-orders     # Get user's orders
POST /api/orders              # Create new order
GET /api/orders/**            # All other order endpoints (proxied)
PUT /api/orders/**            # All other order endpoints (proxied)
DELETE /api/orders/**         # All other order endpoints (proxied)
```

#### Inventory (RESTAURANT role only)
```bash
GET /api/inventory/my-inventory    # Get restaurant's inventory
POST /api/inventory               # Add inventory item
PUT /api/inventory/{itemId}       # Update inventory item
GET /api/inventory/**             # All other inventory endpoints (proxied)
POST /api/inventory/**            # All other inventory endpoints (proxied)
PUT /api/inventory/**             # All other inventory endpoints (proxied)
DELETE /api/inventory/**          # All other inventory endpoints (proxied)
```

## 🔧 Configuration

### Service URLs
The following backend services must be running:
- **Auth Service**: `http://localhost:8081`
- **Order Service**: `http://localhost:9094`
- **Inventory Service**: `http://localhost:9093`
- **API Gateway**: `http://localhost:8080`

### JWT Configuration
- Secret key is configurable in `application.properties`
- Token expiration: 24 hours (configurable)
- Tokens are generated by the auth service and validated by the gateway

### CORS Configuration
- Configured to allow requests from frontend applications
- Default allowed origins: `http://localhost:3000`, `http://localhost:5173`
- Supports all standard HTTP methods

## 🔐 Role-based Access Control

### CUSTOMER Role
- ✅ Can access `/api/orders/**` endpoints
- ✅ Can create orders, view their orders
- ❌ Cannot access inventory management endpoints

### RESTAURANT Role  
- ✅ Can access `/api/inventory/**` endpoints
- ✅ Can manage inventory items, view restaurant inventory
- ❌ Cannot access customer order creation endpoints

## 🛡️ Security Features

- **JWT Token Validation**: All protected endpoints require valid JWT tokens
- **Role-based Authorization**: Endpoints are protected based on user roles
- **CORS Protection**: Properly configured for secure frontend integration
- **Input Validation**: Request validation for all endpoints
- **Error Handling**: Secure error responses without sensitive information

## 📝 Request/Response Examples

### 1. Health Check
```bash
curl -X GET http://localhost:8080/api/health
```

**Response:**
```json
{
  "success": true,
  "message": "API Gateway is running",
  "data": {
    "status": "UP",
    "service": "API Gateway",
    "version": "1.0.0",
    "timestamp": "2025-08-24T12:40:49.831"
  }
}
```

### 2. Customer Registration
```bash
curl -X POST http://localhost:8080/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "john_customer",
    "email": "john@customer.com",
    "password": "password123",
    "firstName": "John",
    "lastName": "Doe",
    "role": "CUSTOMER",
    "address": "456 Customer Ave, City"
  }'
```

**Response:**
```json
{
  "success": true,
  "message": "Success",
  "data": "User registered successfully"
}
```

### 3. Restaurant Registration
```bash
curl -X POST http://localhost:8080/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "pizza_place",
    "email": "owner@pizzaplace.com",
    "password": "password123",
    "firstName": "Mario",
    "lastName": "Rossi",
    "role": "RESTAURANT",
    "restaurantName": "Mario Pizza Place",
    "address": "123 Pizza Street, Food City"
  }'
```

**Response:**
```json
{
  "success": true,
  "message": "Success", 
  "data": "User registered successfully"
}
```

### 4. Customer/Restaurant Login
```bash
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "usernameOrEmail": "john_customer",
    "password": "password123"
  }'
```

**Response:**
```json
{
  "success": true,
  "message": "Success",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJqb2huX2N1c3RvbWVyIiwicm9sZSI6IkNVU1RPTUVSIiwidXNlcklkIjoxMCwiaWF0IjoxNzU2MDE5OTIxLCJleHAiOjE3NTYxMDYzMjF9...",
    "type": "Bearer",
    "username": "john_customer",
    "role": "CUSTOMER",
    "id": 10
  }
}
```

### 5. Authenticated Request (Customer accessing orders)
```bash
curl -X GET http://localhost:8080/api/orders/my-orders \
  -H "Authorization: Bearer YOUR_JWT_TOKEN_HERE"
```

### 6. Authenticated Request (Restaurant accessing inventory)
```bash
curl -X GET http://localhost:8080/api/inventory/my-inventory \
  -H "Authorization: Bearer YOUR_JWT_TOKEN_HERE"
```

## 🚀 Running the Service

### Prerequisites
1. Ensure all backend services are running:
   - Auth Service on port 8081
   - Order Service on port 9094
   - Inventory Service on port 9093

2. Java 21 or higher installed
3. Maven 3.6+ installed

### Build and Run
```bash
# Build the project
./mvnw clean package -DskipTests

# Run the API Gateway
java -jar target/apigateway-0.0.1-SNAPSHOT.jar
```

The API Gateway will start on `http://localhost:8080`

### Alternative: Development Mode
```bash
# Run in development mode with auto-reload
./mvnw spring-boot:run
```

## 🧪 Testing

### Automated Tests
Run the provided test scripts to verify functionality:

```bash
# Complete functionality test
complete_test.bat

```

### Manual Testing
1. **Health Check**: Verify the service is running
2. **Registration**: Test both customer and restaurant registration
3. **Login**: Test login for both roles
4. **Token Validation**: Verify JWT tokens work
5. **Role-based Access**: Test that customers can only access orders and restaurants can only access inventory

## 🐛 Error Handling

### Common Error Responses

**401 Unauthorized**
```json
{
  "success": false,
  "message": "Invalid or expired token"
}
```

**403 Forbidden**
```json
{
  "success": false,
  "message": "Insufficient permissions"
}
```

**500 Internal Server Error**
```json
{
  "success": false,
  "message": "Authentication service error: Service unavailable"
}
```

## 📊 Monitoring

### Health Checks
- **Health Endpoint**: `/api/health` - Returns service status
- **Info Endpoint**: `/api/info` - Returns service information and features

### Logging
- Debug logging enabled for security components
- Request/response logging for troubleshooting
- Error logging for service communication issues

## 🔄 Request Flow

1. **Client Request**: Frontend sends request to API Gateway
2. **Authentication Check**: Gateway validates JWT token (if required)
3. **Authorization Check**: Gateway verifies user role permissions
4. **Service Routing**: Request forwarded to appropriate backend service
5. **Response Processing**: Backend response returned to client
6. **Error Handling**: Any errors are properly formatted and returned

## 🛠️ Development

### Project Structure
```
src/main/java/com/deliverysystem/apigateway/
├── controller/          # REST controllers
├── service/            # Service clients for backend communication  
├── security/           # Security configuration and JWT handling
├── config/             # Application configuration
├── dto/                # Data transfer objects
└── util/               # Utility classes
```

### Key Components
- **AuthController**: Handles authentication endpoints
- **OrderController**: Routes customer order requests
- **InventoryController**: Routes restaurant inventory requests
- **JwtAuthenticationFilter**: Validates JWT tokens
- **SecurityConfig**: Configures security rules
- **Service Clients**: Communicate with backend services

## 🎯 Success Metrics

✅ **Fully Operational Features:**
- Health monitoring and service info
- Customer registration and authentication
- Restaurant registration and authentication  
- JWT token generation and validation
- Role-based access control (CUSTOMER/RESTAURANT)
- Service routing and request proxying
- CORS support for frontend integration
- Comprehensive error handling
- Security token validation

The API Gateway successfully serves as the central hub for the Food Delivery System, providing secure, role-based access to all backend services while maintaining proper authentication and authorization controls.
